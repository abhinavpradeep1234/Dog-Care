{% extends "forget_base.html" %}
{% block title %}
404
{% endblock title %}
{% block content %}
    {% load static %}
    <div class="container  mt-4">
        <div class="row">
            <div class="col-md-6 mx-auto">
                <div class="card">
                    <div class="card-body">
                        <div class="d-flex justify-content-center">
                           <h1 class="mt-4" >4</h1> <img src="{% static "image/favicon.png" %}"width="50" ;height="30"> <h1 class="mt-4">4</h1>
                        </div>
                        <p>
                            404 Page Not Found !! 
                            it means that the page doesn't exists
                            .
                        </p>
                        <div class="d-grid gap-2 d-md-flex justify-content-md-end">
                            <a href="{% url 'home' %}" class="btn btn-primary btn-sm">Back to home</a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
{% endblock content %}


<script>
    // Function to calculate total price
    function calculateTotalPrice() {
        let price = parseFloat(document.getElementById('id_price').value) || 0;
        let quantity = parseFloat(document.getElementById('id_quantity').value) || 0;

        // Calculate the total price
        let totalPrice = price * quantity;

        // Update the total price display, fallback to 0 if NaN
        document.getElementById('total_price').textContent = isNaN(totalPrice) ? "0" : totalPrice.toFixed(2);

        // Return the total price to Razorpay
        return totalPrice;
    }

    // Event listeners for input fields to update the total price
    document.getElementById('id_price').addEventListener('input', calculateTotalPrice);
    document.getElementById('id_quantity').addEventListener('input', calculateTotalPrice);

    // When the Pay button is clicked
    document.getElementById('rzp-button1').onclick = function(e) {
        let totalPrice = calculateTotalPrice();

        // Razorpay payment options
        var options = {
            "key": "rzp_test_bExXeTSGdRlunx", // Enter the Key ID generated from the Dashboard
            "amount": (totalPrice * 100).toFixed(0), // Amount in paise (multiplying by 100)
            "currency": "INR",
            "name": "smart toilet@Authority", // Your business name
            "description": "Public toilet booking",
            "image": "https://example.com/your_logo",
            "order_id": "{{ payment.id }}", // This is a sample Order ID (generated on the server-side)
            "prefill": {
                "name": "Gaurav Kumar", // Your customer's name
                "email": "gaurav.kumar@example.com",
                "contact": "9000090000" // Customer's phone number
            },
            "notes": {
                "address": "Razorpay Corporate Office"
            },
            "theme": {
                "color": "green"
            },
            "handler": function (response) {
                // This function is triggered after payment success
                console.log(response);
                
                // You can send the payment details to your backend here to book the product/service
                fetch('/api/payment-success/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                    },
                    body: JSON.stringify({
                        payment_id: response.razorpay_payment_id,
                        order_id: response.razorpay_order_id,
                        signature: response.razorpay_signature
                    })
                }).then(response => response.json())
                  .then(data => {
                      if (data.success) {
                          alert('Your booking is confirmed!');
                      } else {
                          alert('There was an issue with your booking. Please try again.');
                      }
                  })
                  .catch(error => {
                      alert('Payment failed. Please try again.');
                  });
            }
        };

        var rzp1 = new Razorpay(options);
        rzp1.open();
        e.preventDefault();
    }
</script>


from django.http import JsonResponse
from django.views.decorators.csrf import csrf_exempt
import razorpay
from .models import Booking  # Assuming you have a Booking model

client = razorpay.Client(auth=("rzp_test_bExXeTSGdRlunx", "your_api_secret"))

@csrf_exempt
def payment_success(request):
    if request.method == "POST":
        data = json.loads(request.body)

        # Verify the signature sent by Razorpay
        payment_id = data.get("payment_id")
        order_id = data.get("order_id")
        signature = data.get("signature")
        
        params_dict = {
            'razorpay_order_id': order_id,
            'razorpay_payment_id': payment_id,
            'razorpay_signature': signature
        }

        try:
            # Verify the payment signature
            client.utility.verify_payment_signature(params_dict)

            # If payment is verified, create the booking
            booking = Booking.objects.create(
                payment_id=payment_id,
                order_id=order_id,
                amount_paid=data.get("amount"),
                status="Confirmed"
            )

            return JsonResponse({'success': True, 'message': 'Booking confirmed!'})
        
        except razorpay.errors.SignatureVerificationError:
            return JsonResponse({'success': False, 'message': 'Payment verification failed!'}, status=400)
    else:
        return JsonResponse({'success': False, 'message': 'Invalid request method!'}, status=400)

